<?php
/**
 * @file
 */
define('FREEGEEK_PROGRAM_COMPLETION_HOURS', 24);
define('FREEGEEK_PROGRAM_COMPLETION_CREDIT', 75);
define('FREEGEEK_MAX_YEARLY_HOURS', 75);
define('FREEGEEK_MAXIMUM_CREDIT', 150);
define('FREEGEEK_PROCESSING_OFFSET', 0);

function freegeek_townsquare_rules_rules_event_info() {
  $items = array(
    // An event invoked for every volunteer record processed
    'freegeek_townsquare_rules_process_sessions' => array(
        'label' => t('After processing a volunteer\'s recent participation'),
        'variables' => array(
          'account' => array(
            'type' => 'user',
            'label' => t('User'),
          ),
          'hours_old' => array(
            'type' => 'decimal',
            'label' => t('Old hours'),
          ),
          'hours_new' => array(
            'type' => 'decimal',
            'label' => t('New hours'),
          ),
          'hours_difference' => array(
            'type' => 'decimal',
            'label' => t('Difference'),
          ),
       ),
       'group' => t('Townsquare'),
     ),
  );
  return $items;
}

/**
 * Implements hook_cron().
 */
function freegeek_townsquare_rules_init() {
  // Get all recently updated volunteer sessions, then generate
  // a data structure reflecting new and old hours for all volunteers
  // with recent activity.
  $start = time() - FREEGEEK_PROCESSING_OFFSET;
  $end = variable_get('cron_last') - FREEGEEK_PROCESSING_OFFSET;
  
  $query = new EntityFieldQuery;
  $query
    ->entityCondition('entity_type', 'node')
    ->propertyCondition('type', 'volunteer_session')
    ->propertyCondition('changed', $start, '<')
    ->propertyCondition('changed', $end, '>');
  $result = $query->execute();
  if ($result) {
    $sessions = entity_load('node', array_keys($result['node']));

    // Calculate each user's new and old hours
    $durations = array();
    foreach ($sessions as $nid => $session) {
      dpm($session);
      $session_uid = field_get_items('node', $session, 'field_session_user');
      $session_uid = $session_uid[0]['target_id'];
      if ($session_uid > 0) {
        $session_duration = field_get_items('node', $session, 'field_session_duration');
        $session_hours = field_get_items('node', $session, 'field_session_hours');
        $session_date = date_create($session_hours[0]['value'], timezone_open($session_hours[0]['timezone']));
        $session_year = $session_date->format('Y');

        if (!isset($durations[$session_uid][$session_year])) {
          $durations[$session_uid][$session_year] = array(
            'old' => 0,
            'new' => 0,
          );
        }

        $durations[$session_uid][$session_year]['new'] += $session_duration[0]['value'];

        $old_query = new EntityfieldQuery;
        $old_query
          ->entityCondition('entity_type', 'node')
          ->propertyCondition('type', 'volunteer_session')
          ->propertyCondition('uid', $session_uid, '=')
          ->propertyCondition('changed', $end, '<');
        $old_result = $old_query->execute();

        if ($old_result) {
          $old_sessions = entity_load('node', array_keys($old_result['node']));
          foreach ($old_sessions as $old_session) {
            $old_session_duration = field_get_items('node', $old_session, 'field_session_duration');
            $old_session_hours = field_get_items('node', $old_session, 'field_session_hours');
            $old_session_date = date_create($old_session_hours[0]['value'], timezone_open($old_session_hours[0]['timezone']));
            $old_year = $old_session_date->format('Y');
            if (!isset($durations[$session_uid][$old_year]['old'])) {
              $durations[$session_uid][$old_year]['old'] = 0;
            }
            $durations[$session_uid][$old_year]['old'] += $old_session_duration[0]['value'];
          }
        }
      }
    }
    // Process credit. There might be better ways to do this using Drupal
    // rules module, but the logic is quite specific and complex. If an
    // implementer's use case is roughly similar to FreeGeek, they can 
    // redefine the constants.
    
    // Get current year
    $current_year = Date('Y');
    foreach ($durations as $uid=>$years) {
      $user = user_load($uid);
      $last_processed = field_get_items('user', $user, 'field_freegeek_last_processed');
      $credit = field_get_items('user', $user, 'field_freegeek_volunteer_credit');

      // If 1st year and program completed
      // If 1st year and hours < COMPLETION_HOURS + MAX_YEARLY_HOURS (misnamed, really) 
      // If subsequent year and hours < COMPLETION CREDIT
      
      $first_year = (count($years) === 1);
      $max_hours = ($first_year) ? FREEGEEK_MAX_YEARLY_HOURS + FREEGEEK_PROGRAM_COMPLETION_HOURS : FREEGEEK_MAX_YEARLY_HOURS; 

      foreach ($years as $year => $hours) {
        $new_total = $hours['new'] + $hours['old'];

        // Program completion: 75 bucks plus any extra hours
        if ($first_year && $hours[$current_year]['old'] < FREEGEEK_PROGRAM_COMPLETION_HOURS && $hours[$current_year]['new'] >= FREEGEEK_PROGRAM_COMPLETION_HOURS) {
          $user->field_freegeek_volunteer_credit['und'][0]['value'] = FREEGEEK_PROGRAM_COMPLETION_CREDIT + ($hours['new'] - FREEGEEK_PROGRAM_COMPLETION_HOURS);
        }
        // Under maximum cap
        //else if ($hours['old'] > FREEGEEK_PROGRAM_COMPLETION_HOURS && $hours['old'] <= $max_hours) {
        //  $user->field_freegeek_volunteer_credit['und'][0]['value'] += $difference;
        //  if ($user->field_freegeek_volunteer_credit['und'][0]['value'] > FREEGEEK_MAXIMUM_CREDIT) {
        //    $user->field_freegeek_volunteer_credit['und'][0]['value'] = FREEGEEK_MAXIMUM_CREDIT;
        //  }  
        //}
        //user_save($user);
        //rules_invoke_event('freegeek_townsquare_rules_process_sessions', $user, $hours['old'], $hours['new'], $difference);
      }
    }
  } 
}
